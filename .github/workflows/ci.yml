name: CI Build

on:
  # Trigger on all pull requests to validate builds
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'SECURITY.md'
  
  # Trigger on pushes to branches (but not main, which is handled by deploy workflow)
  push:
    branches-ignore: [ main ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'SECURITY.md'

# Allow only one concurrent CI run per branch/PR
concurrency:
  group: "ci-${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Build validation job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Lint code
        run: npm run lint
      
      - name: Run tests
        run: npm run test:run
      
      - name: Build application
        run: npm run build
      
      - name: Build for GitHub Pages
        run: npm run build:pages
        
      - name: Validate build outputs
        run: |
          echo "Validating standard build..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Standard build failed: dist/index.html not found"
            exit 1
          fi
          echo "âœ… Standard build output validated"
          
          echo "Validating GitHub Pages build..."
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ GitHub Pages build failed: dist/index.html not found"
            exit 1
          fi
          echo "âœ… GitHub Pages build output validated"
      
      - name: Report build success
        run: |
          echo "ğŸ‰ CI Build completed successfully!"
          echo "âœ… Linting passed (with warnings allowed)"
          echo "âœ… All $( npm run test:run 2>&1 | grep -o '[0-9]\+ passed' | head -1 ) tests passed"
          echo "âœ… Standard build completed"
          echo "âœ… GitHub Pages build completed"